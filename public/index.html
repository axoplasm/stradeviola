<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Strade Viola‚Äç</title>
        <link rel="icon" href="favicon.svg">
        <style>
            /* Reset */
            *:where(:not(html, iframe, canvas, img, svg, video, audio):not(svg *, symbol *)) {
                all: unset;
                display: revert;
            }
            *, *::before, *::after {
                box-sizing: border-box;
            }

            /* Base */
            :root {
                color-scheme: light dark;
            }
            html {
                -moz-text-size-adjust: none;
                -webkit-text-size-adjust: none;
                text-size-adjust: none;
                --green: hsl(120, 100%, 30%);
                --purple: hsl(300, 100%, 35%);
                --black: hsl(0, 0%, 0%);
                --white: hsl(0, 0%, 100%);
                --loud: light-dark(var(--black), var(--white));
                --hushed: light-dark(
                    hsl(from var(--black) h 0% 50%),
                    hsl(from var(--black) h 0% 60%)
                );
                --whisper: light-dark(
                    hsl(from var(--black) h 0% 80%),
                    hsl(from var(--black) h 0% 40%)
                );
                --quiet: light-dark(
                    hsl(from var(--black) h 0% 95%),
                    hsl(from var(--black) h 0% 20%)
                );
                --silent: light-dark(var(--white), var(--black));
                --serif: Charter, 'Bitstream Charter', 'Sitka Text', Cambria, serif;
                --monospace: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, 'DejaVu Sans Mono', monospace;
                --default-line-height: 1.5;
                --default-font-size: 14px;
                --bold-weight: 600;
                --border-width: 1px;
                --grid: 1rem;
                --transition-speed: 0.2s;
                --transition-timing-function: ease-in-out;
                font-size: var(--default-font-size);
                height: 100%;
                scroll-behavior: smooth;
            }
            body {
                background: var(--silent);
                color: var(--loud);
                container-type: inline-size;
                font-family: var(--monospace);
                height: 100%;
                line-height: var(--default-line-height);
            }
            main {
                margin-inline: auto;
                max-width: 60rem;
                padding-inline: 1rem;
            }
            h1 {
                font-weight: var(--bold-weight);
                margin-block-end: var(--grid);
                font-size: 2rem;
            }
            table {
                border-collapse: collapse;
                border: var(--border-width) solid var(--hushed);
                margin-block: var(--grid);
                margin-inline: auto;
                text-align: right;
                display: block;
                max-width: 100%;
                overflow-x: auto;
                width: fit-content;
            }
            thead, tfoot {
                background-color: var(--quiet);
                font-weight: var(--bold-weight);
            }
            thead {
                border-block-end: var(--border-width) solid var(--whisper);
            }
            tfoot {
                border-block-start: var(--border-width) solid var(--whisper);
            }
            td, th {
                padding-block: calc(var(--grid) * 0.25);
                padding-inline: calc(var(--grid) * 0.5);
            }
            th {
                font-weight: var(--bold-weight);
            }

            colgroup + colgroup {
                border-inline-start: var(--border-width) solid var(--whisper);
            }

            a {
                text-decoration: none;
                transition: all 0.2s ease-in-out;
                &:link, &:visited {
                    background-color: transparent;
                    border: 2px solid var(--green);
                    color: var(--green);
                    padding: 5px;
                }
                &:hover {
                    background-color: var(--purple);
                    border-color: var(--purple);
                    color: var(--silent);
                    padding: 9px;
                }
            }

            strong {
                font-weight: bold;
            }

            @media (max-width: 799px) {
                html { --default-font-size: 12px; }
            }

            /* Local */
            #chart {
                --chart-km: var(--green);
                --chart-elev: var(--purple);
                --chart-grid: var(--whisper);
                --chart-label: var(--hushed);
                --chart-bg: var(--silent);
                width: 100%;
                height: 300px;
                cursor: pointer;
                font-family: var(--monospace);
                font-size: var(--default-font-size);
                & text { dominant-baseline: middle; }
                .grid { stroke: var(--chart-grid); }
                .label-left, .title-left { fill: var(--chart-km); }
                .label-right, .title-right { fill: var(--chart-elev); }
                .label-left { text-anchor: end; }
                .label-right { text-anchor: start; }
                .title-left, .title-right { text-anchor: middle; }
                .label-x { fill: var(--chart-label); text-anchor: end; }
                .series-km { fill: none; stroke: var(--chart-km); stroke-width: 2; }
                .series-elev { fill: none; stroke: var(--chart-elev); stroke-width: 2; stroke-dasharray: 2 2; }
                .avg-km { stroke: var(--chart-km); }
                .avg-elev { stroke: var(--chart-elev); stroke-dasharray: 2 2; }
                .dot-km { fill: var(--chart-km); }
                .dot-elev { fill: var(--chart-elev); }
                .highlight { stroke: var(--chart-bg); stroke-width: 2; }
                .hit { fill: transparent; }
            }
            .align-center { text-align: center; }
            .fg-green { color: var(--green); }
            .fg-purple { color: var(--purple); }
            .fg-whisper { color: var(--whisper); }
            .bg-quiet { background-color: var(--quiet); }
            .üö¥, .üòà {
                display: inline-block;
            }
            .üö¥ {
                padding-inline-start: 1rem;
                transform: rotate(-30deg) scaleX(-1);
            }
            .üòà {
                padding-inline-start: 0.5rem;
                transform: rotate(30deg);
            }
        </style>
    </head>
    <body>
        <main>
            <h1 class="align-center">
                <span class="üö¥">üö¥</span><span class="fg-green">Strade</span><span class="fg-purple">Viola</span><span class="üòà">üòà</span>
            </h1>
            <svg id="chart"></svg>
            <table>
                <colgroup span="3"></colgroup>
                <colgroup span="4"></colgroup>
                <colgroup span="4"></colgroup>
                <thead>
                    <tr>
                        <th>year</th>
                        <th>rides</th>
                        <th>time</th>
                        <th>dist(km)</th>
                        <th>elev(m)</th>
                        <th class='fg-green'>km/wk</th>
                        <th class='fg-purple'>m/wk</th>
                        <th>dist(mi)</th>
                        <th>elev(ft)</th>
                        <th>mi/wk</th>
                        <th>ft/wk</th>
                    </tr>
                </thead>
                <tbody id="stats"></tbody>
                <tfoot id="totals"></tfoot>
            </table>
            <p class="align-center"><strong><a href="https://github.com/axoplasm/stradeviola">Project on GitHub ‚Üí</a></strong></p>
            <script>
                // -- Constants --

                const KM_TO_MI = 0.621371;
                const M_TO_FT = 3.28084;

                // -- Helpers --

                // Format seconds as "Nh00m" with dimmed unit labels.
                function formatTime(seconds) {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    return h + "<span class='fg-whisper'>h</span>" + String(m).padStart(2, "0") + "<span class='fg-whisper'>m</span>";
                }

                // Return true if the given year is a leap year.
                function isLeapYear(yr) {
                    return (yr % 4 === 0 && yr % 100 !== 0) || yr % 400 === 0;
                }

                // Number of weeks in a year. For past years, uses actual days
                // (365 or 366) divided by 7. For the current year, uses elapsed
                // time so that per-week averages reflect the year so far.
                function weeksInYear(year) {
                    const now = new Date();
                    const yr = parseInt(year);
                    if (yr < now.getFullYear()) return (isLeapYear(yr) ? 366 : 365) / 7;
                    const start = new Date(yr, 0, 1);
                    return Math.max(1, (now - start) / (7 * 24 * 60 * 60 * 1000));
                }

                // -- Chart --

                // Builds a dual-axis line chart as SVG markup.
                // Left axis: km/wk (solid line). Right axis: m/wk (dashed line).
                // Colors and styles are applied via CSS on #chart descendants.
                // Clicking a data point (or table row) highlights it.
                function drawChart(years, avgKmPerWk, avgMPerWk, highlightIndex, avgKm, avgM) {
                    const svg = document.getElementById("chart");
                    const cssWidth = svg.clientWidth;
                    const cssHeight = 300;
                    const narrow = cssWidth < 700;
                    const pad = {top: 24, right: 65, bottom: narrow ? 70 : 46, left: 58};
                    const w = cssWidth - pad.left - pad.right;
                    const h = cssHeight - pad.top - pad.bottom;
                    const n = years.length;

                    const maxKm = Math.ceil(Math.max(...avgKmPerWk) / 25) * 25;
                    const maxElev = Math.ceil(Math.max(...avgMPerWk) / 500) * 500;
                    const steps = 5;

                    const yKm = v => pad.top + h - (h * v / maxKm);
                    const yElev = v => pad.top + h - (h * v / maxElev);
                    const xAt = i => pad.left + (w / (n - 1)) * i;

                    const parts = [];

                    // Gridlines + left axis labels
                    for (let i = 0; i <= steps; i++) {
                        const val = (maxKm / steps) * i;
                        const y = yKm(val);
                        parts.push(`<line class="grid" x1="${pad.left}" y1="${y}" x2="${pad.left + w}" y2="${y}" />`);
                        parts.push(`<text class="label-left" x="${pad.left - 8}" y="${y}">${Math.round(val)}</text>`);
                    }

                    // Right axis labels
                    for (let i = 0; i <= steps; i++) {
                        const val = (maxElev / steps) * i;
                        parts.push(`<text class="label-right" x="${pad.left + w + 8}" y="${yElev(val)}">${Math.round(val).toLocaleString()}</text>`);
                    }

                    // Axis titles
                    parts.push(`<text class="title-left" transform="translate(14,${pad.top + h / 2}) rotate(-90)">km/wk</text>`);
                    parts.push(`<text class="title-right" transform="translate(${cssWidth - 6},${pad.top + h / 2}) rotate(90)">m/wk</text>`);

                    // X axis labels
                    for (let i = 0; i < n; i++)
                        parts.push(`<text class="label-x" transform="translate(${xAt(i)},${pad.top + h + 8}) rotate(-60)">${years[i]}</text>`);

                    // Data series
                    parts.push(`<polyline class="series-km" points="${avgKmPerWk.map((v, i) => `${xAt(i)},${yKm(v)}`).join(" ")}" />`);
                    parts.push(`<polyline class="series-elev" points="${avgMPerWk.map((v, i) => `${xAt(i)},${yElev(v)}`).join(" ")}" />`);

                    // Average reference lines
                    if (avgKm != null)
                        parts.push(`<line class="avg-km" x1="${pad.left}" y1="${yKm(avgKm)}" x2="${pad.left + w}" y2="${yKm(avgKm)}" />`);
                    if (avgM != null)
                        parts.push(`<line class="avg-elev" x1="${pad.left}" y1="${yElev(avgM)}" x2="${pad.left + w}" y2="${yElev(avgM)}" />`);

                    // Data points
                    for (let i = 0; i < n; i++) {
                        const hi = highlightIndex >= 0 && i === highlightIndex;
                        parts.push(`<circle class="dot-km${hi ? " highlight" : ""}" cx="${xAt(i)}" cy="${yKm(avgKmPerWk[i])}" r="${hi ? 8 : 4}" />`);
                    }
                    for (let i = 0; i < n; i++) {
                        const hi = highlightIndex >= 0 && i === highlightIndex;
                        parts.push(`<circle class="dot-elev${hi ? " highlight" : ""}" cx="${xAt(i)}" cy="${yElev(avgMPerWk[i])}" r="${hi ? 8 : 4}" />`);
                    }

                    // Hit targets for click detection
                    const gap = w / (n - 1);
                    for (let i = 0; i < n; i++) {
                        const left = i === 0 ? pad.left : xAt(i) - gap / 2;
                        const right = i === n - 1 ? pad.left + w : xAt(i) + gap / 2;
                        parts.push(`<rect class="hit" data-index="${i}" x="${left}" y="${pad.top}" width="${right - left}" height="${h}" />`);
                    }

                    svg.setAttribute("viewBox", `0 0 ${cssWidth} ${cssHeight}`);
                    svg.innerHTML = parts.join("\n");
                }

                // -- Data loading and table rendering --

                // Fetch yearly stats, populate the table (per-year rows, totals,
                // averages), draw the chart, and wire up click-to-highlight
                // interaction between the table rows and chart data points.
                fetch("/data.json")
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById("stats");
                        
                        // Remove any years with partial data:
                        delete data["2011"];
                        const years = Object.keys(data).sort((a, b) => a - b);
                        const avgKmPerWk = [];
                        const avgMPerWk = [];
                        let totalCount = 0, totalTime = 0, totalDist = 0, totalElev = 0, totalWeeks = 0;
                        for (const year of years) {
                            const y = data[year];
                            const weeks = weeksInYear(year);
                            avgKmPerWk.push(y.distance / weeks);
                            avgMPerWk.push(y.elevation / weeks);
                            totalCount += y.count;
                            totalTime += y.time;
                            totalDist += y.distance;
                            totalElev += y.elevation;
                            totalWeeks += weeks;
                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                "<th>" + year + "</th>" +
                                "<td>" + y.count.toLocaleString() + "</td>" +
                                "<td>" + formatTime(y.time) + "</td>" +
                                "<td>" + y.distance.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                                "<td>" + Math.round(y.elevation).toLocaleString() + "</td>" +
                                "<td class='fg-green'>" + (y.distance / weeks).toFixed(1) + "</td>" +
                                "<td class='fg-purple'>" + Math.round(y.elevation / weeks).toLocaleString() + "</td>" +
                                "<td>" + (y.distance * KM_TO_MI).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                                "<td>" + Math.round(y.elevation * M_TO_FT).toLocaleString() + "</td>" +
                                "<td>" + (y.distance * KM_TO_MI / weeks).toFixed(1) + "</td>" +
                                "<td>" + Math.round(y.elevation * M_TO_FT / weeks).toLocaleString() + "</td>";
                            tbody.appendChild(tr);
                        }
                        const tfoot = document.getElementById("totals");
                        const tfootRow = document.createElement("tr");
                        tfootRow.innerHTML =
                            "<th>TOTAL</th>" +
                            "<td>" + totalCount.toLocaleString() + "</td>" +
                            "<td>" + formatTime(totalTime) + "</td>" +
                            "<td>" + totalDist.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev).toLocaleString() + "</td>" +
                            "<td></td>" +
                            "<td></td>" +
                            "<td>" + (totalDist * KM_TO_MI).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev * M_TO_FT).toLocaleString() + "</td>" +
                            "<td></td>" +
                            "<td></td>";
                        tfoot.appendChild(tfootRow);
                        const currentYearFraction = weeksInYear(String(new Date().getFullYear())) / 52;
                        const effectiveYears = years.length - 1 + currentYearFraction;
                        const avgRow = document.createElement("tr");
                        avgRow.innerHTML =
                            "<th>AVG</th>" +
                            "<td>" + Math.round(totalCount / effectiveYears).toLocaleString() + "</td>" +
                            "<td>" + formatTime(Math.round(totalTime / effectiveYears)) + "</td>" +
                            "<td>" + (totalDist / effectiveYears).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev / effectiveYears).toLocaleString() + "</td>" +
                            "<td class='fg-green'>" + (totalDist / totalWeeks).toFixed(1) + "</td>" +
                            "<td class='fg-purple'>" + Math.round(totalElev / totalWeeks).toLocaleString() + "</td>" +
                            "<td>" + (totalDist * KM_TO_MI / effectiveYears).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev * M_TO_FT / effectiveYears).toLocaleString() + "</td>" +
                            "<td>" + (totalDist * KM_TO_MI / totalWeeks).toFixed(1) + "</td>" +
                            "<td>" + Math.round(totalElev * M_TO_FT / totalWeeks).toLocaleString() + "</td>";
                        tfoot.appendChild(avgRow);
                        const avgKm = totalDist / totalWeeks;
                        const avgM = totalElev / totalWeeks;

                        // Click-to-highlight: clicking a table row or chart
                        // point highlights that year in both the table and chart.
                        // Clicking the same year again deselects it.
                        var selectedIndex = -1;
                        var rows = tbody.querySelectorAll("tr");
                        function selectYear(idx) {
                            selectedIndex = (selectedIndex === idx) ? -1 : idx;
                            rows.forEach(function (r) { r.classList.remove("bg-quiet"); });
                            if (selectedIndex >= 0) rows[selectedIndex].classList.add("bg-quiet");
                            drawChart(years, avgKmPerWk, avgMPerWk, selectedIndex, avgKm, avgM);
                        }
                        rows.forEach(function (tr, idx) {
                            tr.style.cursor = "pointer";
                            tr.addEventListener("click", function () { selectYear(idx); });
                        });
                        document.getElementById("chart").addEventListener("click", function (e) {
                            const hit = e.target.closest(".hit");
                            if (hit) selectYear(parseInt(hit.dataset.index));
                        });
                        drawChart(years, avgKmPerWk, avgMPerWk, selectedIndex, avgKm, avgM);

                        // Redraw the chart on window resize (debounced).
                        let resizeTimer;
                        window.addEventListener("resize", function () {
                            clearTimeout(resizeTimer);
                            resizeTimer = setTimeout(function () {
                                drawChart(years, avgKmPerWk, avgMPerWk, selectedIndex, avgKm, avgM);
                            }, 100);
                        });
                    });
            </script>
        </main>
    </body>
</html>
