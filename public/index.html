<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>üö¥stradeviolaüòà‚Äç</title>
        <link rel="icon" href="favicon.svg">
        <style>
            /* Reset */
            *:where(:not(html, iframe, canvas, img, svg, video, audio):not(svg *, symbol *)) {
                all: unset;
                display: revert;
            }
            *, *::before, *::after {
                box-sizing: border-box;
            }

            /* Base */
            :root {
                color-scheme: light dark;
            }
            html {
                -moz-text-size-adjust: none;
                -webkit-text-size-adjust: none;
                text-size-adjust: none;
                --green: hsl(120, 100%, 30%);
                --purple: hsl(300, 100%, 35%);
                --black: hsl(0, 0%, 0%);
                --white: hsl(0, 0%, 100%);
                --loud: light-dark(var(--black), var(--white));
                --hushed: light-dark(
                    hsl(from var(--black) h 0% 50%),
                    hsl(from var(--black) h 0% 60%)
                );
                --whisper: light-dark(
                    hsl(from var(--black) h 0% 80%),
                    hsl(from var(--black) h 0% 40%)
                );
                --quiet: light-dark(
                    hsl(from var(--black) h 0% 95%),
                    hsl(from var(--black) h 0% 20%)
                );
                --silent: light-dark(var(--white), var(--black));
                --serif: Charter, 'Bitstream Charter', 'Sitka Text', Cambria, serif;
                --monospace: ui-monospace, 'Cascadia Code', 'Source Code Pro', Menlo, Consolas, 'DejaVu Sans Mono', monospace;
                --default-line-height: 1.5;
                --default-font-size: 14px;
                --bold-weight: 600;
                --border-width: 1px;
                --grid: 1rem;
                --transition-speed: 0.2s;
                --transition-timing-function: ease-in-out;
                font-size: var(--default-font-size);
                height: 100%;
                scroll-behavior: smooth;
            }
            body {
                background: var(--silent);
                color: var(--loud);
                container-type: inline-size;
                font-family: var(--monospace);
                height: 100%;
                line-height: var(--default-line-height);
            }
            main {
                margin-inline: auto;
                max-width: 60rem;
                padding-inline: 1rem;
            }
            h1 {
                font-weight: var(--bold-weight);
                margin-block-end: var(--grid);
                font-size: 2rem;
            }
            table {
                border-collapse: collapse;
                border: var(--border-width) solid var(--hushed);
                margin-block: var(--grid);
                margin-inline: auto;
                text-align: right;
            }
            thead, tfoot {
                background-color: var(--quiet);
                font-weight: var(--bold-weight);
            }
            thead {
                border-block-start: var(--border-width) solid var(--hushed);
                border-block-end: var(--border-width) solid var(--whisper);
            }
            tfoot {
                border-block-start: var(--border-width) solid var(--whisper);
                border-block-end: var(--border-width) solid var(--hushed);
            }
            td, th {
                padding-block: calc(var(--grid) * 0.25);
                padding-inline: calc(var(--grid) * 0.5);
            }
            th {
                font-weight: var(--bold-weight);
            }

            colgroup + colgroup {
                border-inline-start: var(--border-width) solid var(--whisper);
            }

            a {
                text-decoration: underline;
                text-decoration-style: solid;
                transition: color 0.2s ease-in-out;
                &:hover {
                    color: var(--purple);
                }
            }
            strong {
                font-weight: bold;
            }

            #chart {
                --chart-km: var(--green);
                --chart-elev: var(--purple);
                --chart-grid: var(--whisper);
                --chart-label: var(--hushed);
                --chart-bg: var(--silent);
            }

            /* Local */
            .align-center { text-align: center; }
            .fg-green { color: var(--green); }
            .fg-purple { color: var(--purple); }
            .fg-whisper { color: var(--whisper); }
            .bg-quiet { background-color: var(--quiet); }
        </style>
    </head>
    <body>
        <main>
            <h1 class="align-center">üö¥<span class="fg-green">strade</span><span class="fg-purple">viola</span>üòà‚Äç</h1>
            <canvas id="chart" style="width:100%"></canvas>
            <table>
                <colgroup span="3"></colgroup>
                <colgroup span="4"></colgroup>
                <colgroup span="4"></colgroup>
                <thead>
                    <tr>
                        <th>year</th>
                        <th>rides</th>
                        <th>time</th>
                        <th>dist(km)</th>
                        <th>elev(m)</th>
                        <th class='fg-green'>km/wk</th>
                        <th class='fg-purple'>m/wk</th>
                        <th>dist(mi)</th>
                        <th>elev(ft)</th>
                        <th>mi/wk</th>
                        <th>ft/wk</th>
                    </tr>
                </thead>
                <tbody id="stats"></tbody>
                <tfoot id="totals"></tfoot>
            </table>
            <p class="align-center"><strong><a href="https://github.com/axoplasm/stradeviola">Project on GitHub ‚Üí</a></strong></p>
            <script>
                const KM_TO_MI = 0.621371;
                const M_TO_FT = 3.28084;

                const chartRule = [...document.styleSheets[0].cssRules].find(r => r.selectorText === "#chart");
                for (const name of chartRule.style)
                    CSS.registerProperty({name, syntax: "<color>", inherits: false, initialValue: "black"});

                function formatTime(seconds) {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    return h + "<span class='fg-whisper'>h</span>" + String(m).padStart(2, "0") + "<span class='fg-whisper'>m</span>";
                }

                function isLeapYear(yr) {
                    return (yr % 4 === 0 && yr % 100 !== 0) || yr % 400 === 0;
                }

                function weeksInYear(year) {
                    const now = new Date();
                    const yr = parseInt(year);
                    if (yr < now.getFullYear()) return (isLeapYear(yr) ? 366 : 365) / 7;
                    const start = new Date(yr, 0, 1);
                    return Math.max(1, (now - start) / (7 * 24 * 60 * 60 * 1000));
                }

                function drawChart(years, avgKmPerWk, avgMPerWk, highlightIndex) {
                    const canvas = document.getElementById("chart");
                    const ctx = canvas.getContext("2d");
                    const dpr = window.devicePixelRatio || 1;
                    const styles = getComputedStyle(canvas);

                    const cssWidth = canvas.clientWidth;
                    const cssHeight = 300;
                    canvas.style.height = cssHeight + "px";
                    canvas.width = cssWidth * dpr;
                    canvas.height = cssHeight * dpr;
                    ctx.scale(dpr, dpr);

                    const kmColor = styles.getPropertyValue("--chart-km");
                    const elevColor = styles.getPropertyValue("--chart-elev");
                    const gridColor = styles.getPropertyValue("--chart-grid");
                    const labelColor = styles.getPropertyValue("--chart-label");
                    const bgColor = styles.getPropertyValue("--chart-bg");
                    const narrow = cssWidth < 700;
                    const pad = {top: 24, right: 65, bottom: narrow ? 70 : 46, left: 58};
                    const w = cssWidth - pad.left - pad.right;
                    const h = cssHeight - pad.top - pad.bottom;
                    const n = years.length;

                    const maxKm = Math.ceil(Math.max(...avgKmPerWk) / 25) * 25;
                    const maxElev = Math.ceil(Math.max(...avgMPerWk) / 500) * 500;

                    ctx.font = "14px 'IBM Plex Mono', monospace";

                    // Y gridlines (left axis)
                    ctx.textAlign = "right";
                    ctx.textBaseline = "middle";
                    const steps = 5;
                    for (let i = 0; i <= steps; i++) {
                        const val = (maxKm / steps) * i;
                        const y = pad.top + h - (h * val / maxKm);
                        ctx.strokeStyle = gridColor;
                        ctx.beginPath();
                        ctx.moveTo(pad.left, y);
                        ctx.lineTo(pad.left + w, y);
                        ctx.stroke();
                        ctx.fillStyle = kmColor;
                        ctx.fillText(Math.round(val), pad.left - 8, y);
                    }

                    // Right axis labels
                    ctx.textAlign = "left";
                    for (let i = 0; i <= steps; i++) {
                        const val = (maxElev / steps) * i;
                        const y = pad.top + h - (h * val / maxElev);
                        ctx.fillStyle = elevColor;
                        ctx.fillText(Math.round(val).toLocaleString(), pad.left + w + 8, y);
                    }

                    // Left Y axis label
                    ctx.save();
                    ctx.translate(14, pad.top + h / 2);
                    ctx.rotate(-Math.PI / 2);
                    ctx.textAlign = "center";
                    ctx.fillStyle = kmColor;
                    ctx.fillText("km/wk", 0, 0);
                    ctx.restore();

                    // Right Y axis label
                    ctx.save();
                    ctx.translate(cssWidth - 6, pad.top + h / 2);
                    ctx.rotate(Math.PI / 2);
                    ctx.textAlign = "center";
                    ctx.fillStyle = elevColor;
                    ctx.fillText("m/wk", 0, 0);
                    ctx.restore();

                    // X labels
                    ctx.fillStyle = labelColor;
                    for (let i = 0; i < n; i++) {
                        const x = pad.left + (w / (n - 1)) * i;
                        ctx.save();
                        ctx.translate(x, pad.top + h + 8);
                        ctx.rotate(-Math.PI / 4);
                        ctx.textAlign = "right";
                        ctx.textBaseline = "middle";
                        ctx.fillText(years[i], 0, 0);
                        ctx.restore();
                    }

                    function drawLine(values, maxVal, color, dashed) {
                        ctx.beginPath();
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        ctx.setLineDash(dashed ? [2, 2] : []);
                        for (let i = 0; i < n; i++) {
                            const x = pad.left + (w / (n - 1)) * i;
                            const y = pad.top + h - (h * values[i] / maxVal);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();

                        ctx.fillStyle = color;
                        for (let i = 0; i < n; i++) {
                            const x = pad.left + (w / (n - 1)) * i;
                            const y = pad.top + h - (h * values[i] / maxVal);
                            ctx.beginPath();
                            if (highlightIndex >= 0 && i === highlightIndex) {
                                ctx.arc(x, y, 8, 0, Math.PI * 2);
                                ctx.fill();
                                ctx.strokeStyle = bgColor;
                                ctx.lineWidth = 2;
                                ctx.setLineDash([]);
                                ctx.stroke();
                            } else {
                                ctx.arc(x, y, 4, 0, Math.PI * 2);
                                ctx.fill();
                            }
                        }
                    }

                    drawLine(avgKmPerWk, maxKm, kmColor, false);
                    drawLine(avgMPerWk, maxElev, elevColor, true);
                }

                fetch("/data.json")
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById("stats");
                        
                        // Remove any years with partial data:
                        delete data["2011"];
                        const years = Object.keys(data).sort((a, b) => a - b);
                        const avgKmPerWk = [];
                        const avgMPerWk = [];
                        let totalCount = 0, totalTime = 0, totalDist = 0, totalElev = 0, totalWeeks = 0;
                        for (const year of years) {
                            const y = data[year];
                            const weeks = weeksInYear(year);
                            avgKmPerWk.push(y.distance / weeks);
                            avgMPerWk.push(y.elevation / weeks);
                            totalCount += y.count;
                            totalTime += y.time;
                            totalDist += y.distance;
                            totalElev += y.elevation;
                            totalWeeks += weeks;
                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                "<th>" + year + "</th>" +
                                "<td>" + y.count.toLocaleString() + "</td>" +
                                "<td>" + formatTime(y.time) + "</td>" +
                                "<td>" + y.distance.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                                "<td>" + Math.round(y.elevation).toLocaleString() + "</td>" +
                                "<td class='fg-green'>" + (y.distance / weeks).toFixed(1) + "</td>" +
                                "<td class='fg-purple'>" + Math.round(y.elevation / weeks).toLocaleString() + "</td>" +
                                "<td>" + (y.distance * KM_TO_MI).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                                "<td>" + Math.round(y.elevation * M_TO_FT).toLocaleString() + "</td>" +
                                "<td>" + (y.distance * KM_TO_MI / weeks).toFixed(1) + "</td>" +
                                "<td>" + Math.round(y.elevation * M_TO_FT / weeks).toLocaleString() + "</td>";
                            tbody.appendChild(tr);
                        }
                        const tfoot = document.getElementById("totals");
                        const tfootRow = document.createElement("tr");
                        tfootRow.innerHTML =
                            "<th>TOTAL</th>" +
                            "<td>" + totalCount.toLocaleString() + "</td>" +
                            "<td>" + formatTime(totalTime) + "</td>" +
                            "<td>" + totalDist.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev).toLocaleString() + "</td>" +
                            "<td></td>" +
                            "<td></td>" +
                            "<td>" + (totalDist * KM_TO_MI).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev * M_TO_FT).toLocaleString() + "</td>" +
                            "<td></td>" +
                            "<td></td>";
                        tfoot.appendChild(tfootRow);
                        const currentYearFraction = weeksInYear(String(new Date().getFullYear())) / 52;
                        const effectiveYears = years.length - 1 + currentYearFraction;
                        const avgRow = document.createElement("tr");
                        avgRow.innerHTML =
                            "<th>AVG</th>" +
                            "<td>" + Math.round(totalCount / effectiveYears).toLocaleString() + "</td>" +
                            "<td>" + formatTime(Math.round(totalTime / effectiveYears)) + "</td>" +
                            "<td>" + (totalDist / effectiveYears).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev / effectiveYears).toLocaleString() + "</td>" +
                            "<td class='fg-green'>" + (totalDist / totalWeeks).toFixed(1) + "</td>" +
                            "<td class='fg-purple'>" + Math.round(totalElev / totalWeeks).toLocaleString() + "</td>" +
                            "<td>" + (totalDist * KM_TO_MI / effectiveYears).toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                            "<td>" + Math.round(totalElev * M_TO_FT / effectiveYears).toLocaleString() + "</td>" +
                            "<td>" + (totalDist * KM_TO_MI / totalWeeks).toFixed(1) + "</td>" +
                            "<td>" + Math.round(totalElev * M_TO_FT / totalWeeks).toLocaleString() + "</td>";
                        tfoot.appendChild(avgRow);
                        var selectedIndex = -1;
                        var rows = tbody.querySelectorAll("tr");
                        function selectYear(idx) {
                            selectedIndex = (selectedIndex === idx) ? -1 : idx;
                            rows.forEach(function (r) { r.classList.remove("bg-quiet"); });
                            if (selectedIndex >= 0) rows[selectedIndex].classList.add("bg-quiet");
                            drawChart(years, avgKmPerWk, avgMPerWk, selectedIndex);
                        }
                        rows.forEach(function (tr, idx) {
                            tr.style.cursor = "pointer";
                            tr.addEventListener("click", function () { selectYear(idx); });
                        });
                        var chart = document.getElementById("chart");
                        chart.style.cursor = "pointer";
                        chart.addEventListener("click", function (e) {
                            var rect = this.getBoundingClientRect();
                            var clickX = e.clientX - rect.left;
                            var cssWidth = this.clientWidth;
                            var padLeft = 58, padRight = 65;
                            var w = cssWidth - padLeft - padRight;
                            var n = years.length;
                            var gap = w / (n - 1);
                            var idx = Math.round((clickX - padLeft) / gap);
                            if (idx >= 0 && idx < n) selectYear(idx);
                        });
                        drawChart(years, avgKmPerWk, avgMPerWk, selectedIndex);
                        let resizeTimer;
                        window.addEventListener("resize", function () {
                            clearTimeout(resizeTimer);
                            resizeTimer = setTimeout(function () {
                                drawChart(years, avgKmPerWk, avgMPerWk, selectedIndex);
                            }, 100);
                        });
                    });
            </script>
        </main>
    </body>
</html>
