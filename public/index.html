<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Yearly Cycling Stats</title>
        <link rel="stylesheet" href="reset.css">
        <link rel="stylesheet" href="base.css">
        <link rel="stylesheet" href="local.css">
    </head>
    <body>
        <main>
            <h1>Yearly Cycling Stats</h1>
            <canvas id="chart" style="width:100%"></canvas>
            <table>
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>Rides</th>
                        <th>Time</th>
                        <th>Distance (km)</th>
                        <th>Elevation (m)</th>
                        <th>Avg km/wk</th>
                        <th>Avg m/wk</th>
                    </tr>
                </thead>
                <tbody id="stats"></tbody>
            </table>
            <script>
                function formatTime(seconds) {
                    const h = Math.floor(seconds / 3600);
                    const m = Math.floor((seconds % 3600) / 60);
                    return h + "h " + String(m).padStart(2, "0") + "m";
                }

                function weeksInYear(year) {
                    const now = new Date();
                    const yr = parseInt(year);
                    if (yr < now.getFullYear()) return 52;
                    const start = new Date(yr, 0, 1);
                    return Math.max(1, (now - start) / (7 * 24 * 60 * 60 * 1000));
                }

                function drawChart(years, avgKmPerWk, avgMPerWk) {
                    const canvas = document.getElementById("chart");
                    const ctx = canvas.getContext("2d");
                    const dpr = window.devicePixelRatio || 1;

                    const cssWidth = canvas.clientWidth;
                    const cssHeight = 300;
                    canvas.style.height = cssHeight + "px";
                    canvas.width = cssWidth * dpr;
                    canvas.height = cssHeight * dpr;
                    ctx.scale(dpr, dpr);

                    const kmColor = "#2563eb";
                    const elevColor = "#d97706";
                    const pad = {top: 20, right: 55, bottom: 40, left: 50};
                    const w = cssWidth - pad.left - pad.right;
                    const h = cssHeight - pad.top - pad.bottom;
                    const n = years.length;

                    const maxKm = Math.ceil(Math.max(...avgKmPerWk) / 25) * 25;
                    const maxElev = Math.ceil(Math.max(...avgMPerWk) / 500) * 500;

                    ctx.font = "12px system-ui, sans-serif";

                    // Y gridlines (left axis)
                    ctx.textAlign = "right";
                    ctx.textBaseline = "middle";
                    const steps = 5;
                    for (let i = 0; i <= steps; i++) {
                        const val = (maxKm / steps) * i;
                        const y = pad.top + h - (h * val / maxKm);
                        ctx.strokeStyle = "#e0e0e0";
                        ctx.beginPath();
                        ctx.moveTo(pad.left, y);
                        ctx.lineTo(pad.left + w, y);
                        ctx.stroke();
                        ctx.fillStyle = kmColor;
                        ctx.fillText(Math.round(val), pad.left - 8, y);
                    }

                    // Right axis labels
                    ctx.textAlign = "left";
                    for (let i = 0; i <= steps; i++) {
                        const val = (maxElev / steps) * i;
                        const y = pad.top + h - (h * val / maxElev);
                        ctx.fillStyle = elevColor;
                        ctx.fillText(Math.round(val).toLocaleString(), pad.left + w + 8, y);
                    }

                    // Left Y axis label
                    ctx.save();
                    ctx.translate(14, pad.top + h / 2);
                    ctx.rotate(-Math.PI / 2);
                    ctx.textAlign = "center";
                    ctx.fillStyle = kmColor;
                    ctx.fillText("km/wk", 0, 0);
                    ctx.restore();

                    // Right Y axis label
                    ctx.save();
                    ctx.translate(cssWidth - 6, pad.top + h / 2);
                    ctx.rotate(Math.PI / 2);
                    ctx.textAlign = "center";
                    ctx.fillStyle = elevColor;
                    ctx.fillText("m/wk", 0, 0);
                    ctx.restore();

                    // X labels
                    ctx.textAlign = "center";
                    ctx.textBaseline = "top";
                    ctx.fillStyle = "#666";
                    for (let i = 0; i < n; i++) {
                        const x = pad.left + (w / (n - 1)) * i;
                        ctx.fillText(years[i], x, pad.top + h + 8);
                    }

                    function drawLine(values, maxVal, color) {
                        ctx.beginPath();
                        ctx.strokeStyle = color;
                        ctx.lineWidth = 2;
                        for (let i = 0; i < n; i++) {
                            const x = pad.left + (w / (n - 1)) * i;
                            const y = pad.top + h - (h * values[i] / maxVal);
                            if (i === 0) ctx.moveTo(x, y);
                            else ctx.lineTo(x, y);
                        }
                        ctx.stroke();

                        ctx.fillStyle = color;
                        for (let i = 0; i < n; i++) {
                            const x = pad.left + (w / (n - 1)) * i;
                            const y = pad.top + h - (h * values[i] / maxVal);
                            ctx.beginPath();
                            ctx.arc(x, y, 3, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }

                    drawLine(avgKmPerWk, maxKm, kmColor);
                    drawLine(avgMPerWk, maxElev, elevColor);
                }

                fetch("/data.json")
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById("stats");
                        delete data["2011"];
                        const years = Object.keys(data).sort((a, b) => a - b);
                        const avgKmPerWk = [];
                        const avgMPerWk = [];
                        for (const year of years) {
                            const y = data[year];
                            const weeks = weeksInYear(year);
                            avgKmPerWk.push(y.distance / weeks);
                            avgMPerWk.push(y.elevation / weeks);
                            const tr = document.createElement("tr");
                            tr.innerHTML =
                                "<th>" + year + "</th>" +
                                "<td>" + y.count.toLocaleString() + "</td>" +
                                "<td>" + formatTime(y.time) + "</td>" +
                                "<td>" + y.distance.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1}) + "</td>" +
                                "<td>" + Math.round(y.elevation).toLocaleString() + "</td>" +
                                "<td>" + (y.distance / weeks).toFixed(1) + "</td>" +
                                "<td>" + Math.round(y.elevation / weeks).toLocaleString() + "</td>";
                            tbody.appendChild(tr);
                        }
                        drawChart(years, avgKmPerWk, avgMPerWk);
                    });
            </script>
        </main>
    </body>
</html>
